# Before adding this file to your project be sure that you've done step creating ssh key on your
# Linux machine and copy content of public key which located ~/.ssh/id_rsa.pub to this file ~/.ssh/authorized_keys on your VPS
# SSH_PRIVATE_KEY: Private key content generated by ssh-keygen in your Linux machine
# SSH_PRIVATE_KEY_NAME: Private key filename which located ~/.ssh/id_rsa for example
# SSH_USER: Username identity of user on VPS
# SSH_HOST: Ip or DNS host of VPS
# SSH_USER_PASSWORD: Password identity of user on VPS
# All variables above need to be defined on gitlab variables

stages:
  - build-and-test
  - deploy-vps

build-and-test:
  image: python:3.8
  stage: build-and-test
  script: |
    python -m venv ./venv
    source ./venv/bin/activate
    pip install -r requirements.txt
    pytest --version
    pytest ./tests/
  only:
    - test

deploy-vps:
  stage: deploy-vps
  image: ubuntu:20.04
  before_script:
    - "which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )"
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/$SSH_PRIVATE_KEY_NAME
    - chmod 700 ~/.ssh/$SSH_PRIVATE_KEY_NAME
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/$SSH_PRIVATE_KEY_NAME
  script: |
    echo "Deploying to VPS server"
    CURRENTDATE=`date +"%s"`
    # Create directory for contain files to deploy project
    ssh -o StrictHostKeyChecking=no -i  ~/.ssh/$SSH_PRIVATE_KEY_NAME $SSH_USER@$SSH_HOST mkdir -p deploy_$CURRENTDATE/scripts/aws
    ssh -o StrictHostKeyChecking=no -i  ~/.ssh/$SSH_PRIVATE_KEY_NAME $SSH_USER@$SSH_HOST mkdir -p deploy_$CURRENTDATE/scripts/vps

    # Transfer deploy files to server
    scp -o StrictHostKeyChecking=no -i  ~/.ssh/$SSH_PRIVATE_KEY_NAME ./scripts/aws/install_dependencies.sh $SSH_USER@$SSH_HOST:deploy_$CURRENTDATE/scripts/aws/install_dependencies.sh
    scp -o StrictHostKeyChecking=no -i  ~/.ssh/$SSH_PRIVATE_KEY_NAME ./scripts/vps/deploy.sh $SSH_USER@$SSH_HOST:deploy_$CURRENTDATE/scripts/vps/deploy.sh
    scp -o StrictHostKeyChecking=no -i  ~/.ssh/$SSH_PRIVATE_KEY_NAME ./project.settings $SSH_USER@$SSH_HOST:
    
    # Execute transfered files
    ssh -o StrictHostKeyChecking=no -i  ~/.ssh/$SSH_PRIVATE_KEY_NAME $SSH_USER@$SSH_HOST "echo $SSH_USER_PASSWORD | sudo -S chmod +x ./deploy_$CURRENTDATE/scripts/aws/install_dependencies.sh && ./deploy_$CURRENTDATE/scripts/aws/install_dependencies.sh"
    ssh -o StrictHostKeyChecking=no -i  ~/.ssh/$SSH_PRIVATE_KEY_NAME $SSH_USER@$SSH_HOST "echo $SSH_USER_PASSWORD | sudo -S chmod +x ./deploy_$CURRENTDATE/scripts/vps/deploy.sh && ./deploy_$CURRENTDATE/scripts/vps/deploy.sh"
    echo "Deploy done!"
  only:
    - main
